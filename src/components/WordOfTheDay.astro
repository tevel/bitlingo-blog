---
/**
 * Word of the Day Widget
 * Displays a daily featured vocabulary word with pronunciation, definition, and example.
 */
import { getTodaysWord, getLevelColor, getLevelDescription, type CEFRLevel } from '../data/wordOfTheDay';

interface Props {
  lang?: string;
}

const { lang = 'es' } = Astro.props;

const word = getTodaysWord(lang);
const levelColor = word ? getLevelColor(word.level) : '#888';
const levelDesc = word ? getLevelDescription(word.level) : '';
---

{word && (
  <div class="wotd-widget" data-lang={lang}>
    <div class="wotd-header">
      <div class="wotd-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
        </svg>
        <span>Word of the Day</span>
      </div>
      <span class="wotd-level" style={`background-color: ${levelColor}`}>
        {word.level} Â· {levelDesc}
      </span>
    </div>
    
    <div class="wotd-content">
      <div class="wotd-word-row">
        <h3 class="wotd-word">{word.word}</h3>
        <button class="wotd-audio-btn" id="wotd-speak" aria-label="Listen to pronunciation">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
          </svg>
        </button>
      </div>
      
      <p class="wotd-pronunciation">/{word.pronunciation}/</p>
      <p class="wotd-pos">{word.partOfSpeech}</p>
      
      <p class="wotd-definition">{word.definition}</p>
      
      <div class="wotd-example">
        <p class="wotd-example-text">"{word.example}"</p>
        <p class="wotd-example-translation">{word.exampleTranslation}</p>
      </div>
      
      <div class="wotd-category">
        <span class="category-tag">#{word.category}</span>
      </div>
    </div>
    
    <div class="wotd-actions">
      <button class="wotd-action-btn save-btn" id="wotd-save">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
        </svg>
        <span>Save Word</span>
      </button>
      <button class="wotd-action-btn share-btn" id="wotd-share">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        <span>Share</span>
      </button>
    </div>
  </div>
)}

<script define:vars={{ word, lang }}>
  document.addEventListener('DOMContentLoaded', () => {
    const speakBtn = document.getElementById('wotd-speak');
    const saveBtn = document.getElementById('wotd-save');
    const shareBtn = document.getElementById('wotd-share');
    
    if (speakBtn && word) {
      speakBtn.addEventListener('click', () => {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(word.word);
          utterance.lang = lang === 'zh' ? 'zh-CN' : 
                          lang === 'ja' ? 'ja-JP' : 
                          lang === 'ko' ? 'ko-KR' : 
                          lang === 'ar' ? 'ar-SA' : 
                          lang === 'hi' ? 'hi-IN' : 
                          lang === 'he' ? 'he-IL' : 
                          `${lang}-${lang.toUpperCase()}`;
          utterance.rate = 0.8;
          speechSynthesis.speak(utterance);
          
          // Animate button
          speakBtn.classList.add('speaking');
          utterance.onend = () => speakBtn.classList.remove('speaking');
        }
      });
    }
    
    if (saveBtn && word) {
      // Check if already saved
      const savedWords = JSON.parse(localStorage.getItem(`vocabulary_bank_${lang}`) || '[]');
      const isSaved = savedWords.some((w) => w.word === word.word);
      if (isSaved) {
        saveBtn.classList.add('saved');
        const span = saveBtn.querySelector('span');
        if (span) span.textContent = 'Saved!';
      }
      
      saveBtn.addEventListener('click', () => {
        let savedWords = JSON.parse(localStorage.getItem(`vocabulary_bank_${lang}`) || '[]');
        const existingIndex = savedWords.findIndex((w) => w.word === word.word);
        
        if (existingIndex === -1) {
          savedWords.unshift({ ...word, savedAt: Date.now() });
          localStorage.setItem(`vocabulary_bank_${lang}`, JSON.stringify(savedWords));
          saveBtn.classList.add('saved');
          const span = saveBtn.querySelector('span');
          if (span) span.textContent = 'Saved!';
          
          // Award XP
          window.dispatchEvent(new CustomEvent('xp:gained', { detail: { amount: 5, reason: 'Saved word of the day' } }));
          
          // Trigger Pixel reaction
          if (window.pixelRobot) {
            window.pixelRobot.trigger('happy', 'Great! Word saved to your vocabulary bank! ðŸ“š');
          }
        } else {
          // Remove from saved
          savedWords.splice(existingIndex, 1);
          localStorage.setItem(`vocabulary_bank_${lang}`, JSON.stringify(savedWords));
          saveBtn.classList.remove('saved');
          const span = saveBtn.querySelector('span');
          if (span) span.textContent = 'Save Word';
        }
      });
    }
    
    if (shareBtn && word) {
      shareBtn.addEventListener('click', async () => {
        const shareText = `ðŸ“– Word of the Day: ${word.word} (${word.pronunciation})\n\n${word.definition}\n\nExample: "${word.example}"\n\nLearn more at BitLingo!`;
        
        if (navigator.share) {
          try {
            await navigator.share({
              title: `Word of the Day: ${word.word}`,
              text: shareText,
              url: window.location.href,
            });
          } catch (err) {
            // User cancelled or error
          }
        } else {
          // Fallback to clipboard
          await navigator.clipboard.writeText(shareText);
          const span = shareBtn.querySelector('span');
          if (span) {
            const original = span.textContent;
            span.textContent = 'Copied!';
            setTimeout(() => { span.textContent = original; }, 2000);
          }
        }
      });
    }
  });
</script>

<style>
  .wotd-widget {
    background: linear-gradient(145deg, rgba(245, 166, 35, 0.15), rgba(245, 166, 35, 0.05));
    border: 1px solid rgba(245, 166, 35, 0.3);
    border-radius: 20px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
  }
  
  .wotd-widget::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(245, 166, 35, 0.1) 0%, transparent 60%);
    pointer-events: none;
  }
  
  .wotd-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .wotd-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--accent-primary);
    font-weight: 600;
    font-size: 0.9rem;
  }
  
  .wotd-badge svg {
    width: 18px;
    height: 18px;
    fill: var(--accent-primary);
    stroke: var(--accent-primary);
  }
  
  .wotd-level {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    color: white;
  }
  
  .wotd-content {
    position: relative;
    z-index: 1;
  }
  
  .wotd-word-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.25rem;
  }
  
  .wotd-word {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }
  
  .wotd-audio-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent-primary);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .wotd-audio-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(245, 166, 35, 0.4);
  }
  
  .wotd-audio-btn.speaking {
    animation: pulse-audio 0.5s ease infinite;
  }
  
  @keyframes pulse-audio {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
  }
  
  .wotd-audio-btn svg {
    width: 20px;
    height: 20px;
    stroke: var(--bg-deep);
  }
  
  .wotd-pronunciation {
    font-size: 1rem;
    color: var(--text-muted);
    font-style: italic;
    margin: 0 0 0.25rem;
  }
  
  .wotd-pos {
    font-size: 0.85rem;
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 1rem;
  }
  
  .wotd-definition {
    font-size: 1.25rem;
    color: var(--text-primary);
    margin: 0 0 1rem;
    font-weight: 500;
  }
  
  .wotd-example {
    background: rgba(0, 0, 0, 0.2);
    border-left: 3px solid var(--accent-primary);
    padding: 0.75rem 1rem;
    border-radius: 0 10px 10px 0;
    margin-bottom: 1rem;
  }
  
  .wotd-example-text {
    font-size: 1rem;
    color: var(--text-primary);
    margin: 0 0 0.5rem;
    font-style: italic;
  }
  
  .wotd-example-translation {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin: 0;
  }
  
  .wotd-category {
    margin-bottom: 1rem;
  }
  
  .category-tag {
    font-size: 0.8rem;
    color: var(--text-muted);
    background: rgba(255, 255, 255, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
  }
  
  .wotd-actions {
    display: flex;
    gap: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-subtle);
  }
  
  .wotd-action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .wotd-action-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-primary);
  }
  
  .wotd-action-btn svg {
    width: 18px;
    height: 18px;
  }
  
  .wotd-action-btn.saved {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: var(--bg-deep);
  }
  
  .wotd-action-btn.saved svg {
    fill: var(--bg-deep);
    stroke: var(--bg-deep);
  }
  
  @media (max-width: 480px) {
    .wotd-word {
      font-size: 1.5rem;
    }
    
    .wotd-actions {
      flex-direction: column;
    }
  }
</style>
