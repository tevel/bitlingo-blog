---
/**
 * Progress Widget Component
 * Shows user's streak, XP, level, and badges
 * Appears in header or sidebar
 */

import { DEFAULT_LANG } from '../consts';

interface Props {
  compact?: boolean;
  lang?: string;
}

const { compact = false, lang = DEFAULT_LANG } = Astro.props;
const progressPageUrl = `/blog/${lang}/progress`;
---

<a href={progressPageUrl} class={`progress-widget ${compact ? 'compact' : ''}`} id="progress-widget">
  <div class="progress-content">
    <!-- Streak -->
    <div class="stat streak-stat">
      <span class="stat-icon">üî•</span>
      <div class="stat-info">
        <span class="stat-value" id="streak-value">0</span>
        <span class="stat-label">day streak</span>
      </div>
    </div>

    <!-- Level & XP -->
    <div class="stat level-stat">
      <span class="stat-icon">‚≠ê</span>
      <div class="stat-info">
        <span class="stat-value" id="level-value">1</span>
        <span class="stat-label" id="level-title">Beginner</span>
      </div>
    </div>

    <!-- XP Progress Bar -->
    <div class="xp-bar-container">
      <div class="xp-info">
        <span id="xp-current">0</span> XP
        <span class="xp-next">/ <span id="xp-next">100</span></span>
      </div>
      <div class="xp-bar">
        <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Badges Preview -->
    <div class="badges-preview" id="badges-preview">
      <div class="badges-list"></div>
      <button class="badges-expand" id="badges-expand" aria-label="View all badges">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4"/>
          <path d="M12 8h.01"/>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- XP Gain Notification -->
  <div class="xp-notification" id="xp-notification" hidden>
    <span class="xp-gain">+0 XP</span>
  </div>
</a>

<!-- Badges Modal -->
<div class="badges-modal" id="badges-modal" hidden>
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>üèÜ Your Achievements</h3>
      <button class="modal-close" id="modal-close" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-stats">
      <div class="modal-stat">
        <span class="modal-stat-value" id="modal-xp">0</span>
        <span class="modal-stat-label">Total XP</span>
      </div>
      <div class="modal-stat">
        <span class="modal-stat-value" id="modal-articles">0</span>
        <span class="modal-stat-label">Articles Read</span>
      </div>
      <div class="modal-stat">
        <span class="modal-stat-value" id="modal-games">0</span>
        <span class="modal-stat-label">Games Played</span>
      </div>
    </div>
    <div class="badges-grid" id="badges-grid"></div>
    
    <!-- How to Make Progress Section -->
    <div class="progress-guide">
      <h4>üìà How to Make Progress</h4>
      <div class="guide-list">
        <div class="guide-item">
          <span class="guide-icon">üìñ</span>
          <div class="guide-content">
            <strong>Read Articles</strong>
            <span class="guide-xp">+10 XP per article</span>
          </div>
        </div>
        <div class="guide-item">
          <span class="guide-icon">üéØ</span>
          <div class="guide-content">
            <strong>Complete Quizzes</strong>
            <span class="guide-xp">+50 XP per quiz</span>
          </div>
        </div>
        <div class="guide-item">
          <span class="guide-icon">üéÆ</span>
          <div class="guide-content">
            <strong>Play Games</strong>
            <span class="guide-xp">+30 XP per game</span>
          </div>
        </div>
        <div class="guide-item">
          <span class="guide-icon">üî•</span>
          <div class="guide-content">
            <strong>Daily Visit</strong>
            <span class="guide-xp">+10 XP + streak bonus</span>
          </div>
        </div>
        <div class="guide-item">
          <span class="guide-icon">‚≠ê</span>
          <div class="guide-content">
            <strong>Level Up</strong>
            <span class="guide-xp">Earn XP to unlock new levels</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const widget = document.getElementById('progress-widget');
    if (!widget) {
      console.warn('ProgressWidget: Widget element not found');
      return;
    }
    
    // Ensure widget is clickable
    widget.style.cursor = 'pointer';
    widget.style.pointerEvents = 'auto';

    // Initialize gamification if not loaded
    const initGamification = () => {
      if (!window.bitlingoProgress) {
        // Minimal fallback
        const stored = localStorage.getItem('bitlingo-progress');
        return stored ? JSON.parse(stored) : {
          xp: 0, level: 1, streak: 0, lastVisit: '', articlesRead: [],
          gamesPlayed: 0, quizzesCompleted: 0, badges: [], totalVisits: 0
        };
      }
      return window.bitlingoProgress.getProgress();
    };

    const LEVELS = [
      { level: 1, xp: 0, title: 'Beginner' },
      { level: 2, xp: 100, title: 'Learner' },
      { level: 3, xp: 300, title: 'Explorer' },
      { level: 4, xp: 600, title: 'Enthusiast' },
      { level: 5, xp: 1000, title: 'Scholar' },
      { level: 6, xp: 1500, title: 'Expert' },
      { level: 7, xp: 2200, title: 'Master' },
      { level: 8, xp: 3000, title: 'Champion' },
      { level: 9, xp: 4000, title: 'Legend' },
      { level: 10, xp: 5500, title: 'Polyglot' },
    ];

    const BADGES = [
      { id: 'first_steps', name: 'First Steps', icon: 'üöÄ' },
      { id: 'bookworm', name: 'Bookworm', icon: 'üìö' },
      { id: 'quiz_master', name: 'Quiz Master', icon: 'üéØ' },
      { id: 'game_lover', name: 'Game Lover', icon: 'üéÆ' },
      { id: 'streak_starter', name: 'Streak Starter', icon: 'üî•' },
      { id: 'week_warrior', name: 'Week Warrior', icon: '‚ö°' },
      { id: 'dedicated_learner', name: 'Dedicated Learner', icon: 'üëë' },
      { id: 'level_5', name: 'Rising Star', icon: '‚≠ê' },
      { id: 'level_10', name: 'Polyglot', icon: 'üèÜ' },
      { id: 'xp_1000', name: 'XP Hunter', icon: 'üíé' },
    ];

    // Update display
    const updateDisplay = (progress) => {
      const streakEl = document.getElementById('streak-value');
      const levelEl = document.getElementById('level-value');
      const levelTitleEl = document.getElementById('level-title');
      const xpCurrentEl = document.getElementById('xp-current');
      const xpNextEl = document.getElementById('xp-next');
      const xpFillEl = document.getElementById('xp-fill');
      const badgesListEl = document.querySelector('.badges-list');
      
      if (streakEl) streakEl.textContent = progress.streak.toString();
      if (levelEl) levelEl.textContent = progress.level.toString();
      
      const levelInfo = LEVELS.find(l => l.level === progress.level) || LEVELS[0];
      const nextLevel = LEVELS.find(l => l.level === progress.level + 1);
      
      if (levelTitleEl) levelTitleEl.textContent = levelInfo.title;
      if (xpCurrentEl) xpCurrentEl.textContent = progress.xp.toString();
      
      if (nextLevel) {
        if (xpNextEl) xpNextEl.textContent = nextLevel.xp.toString();
        const progressPercent = ((progress.xp - levelInfo.xp) / (nextLevel.xp - levelInfo.xp)) * 100;
        if (xpFillEl) xpFillEl.style.width = `${Math.min(100, progressPercent)}%`;
      } else {
        if (xpNextEl) xpNextEl.textContent = 'MAX';
        if (xpFillEl) xpFillEl.style.width = '100%';
      }
      
      // Update badges preview
      if (badgesListEl) {
        const earnedBadges = BADGES.filter(b => progress.badges.includes(b.id)).slice(-3);
        badgesListEl.innerHTML = earnedBadges.map(b => 
          `<span class="badge-icon" title="${b.name}">${b.icon}</span>`
        ).join('');
      }
      
      // Update modal stats
      const modalXp = document.getElementById('modal-xp');
      const modalArticles = document.getElementById('modal-articles');
      const modalGames = document.getElementById('modal-games');
      
      if (modalXp) modalXp.textContent = progress.xp.toString();
      if (modalArticles) modalArticles.textContent = progress.articlesRead.length.toString();
      if (modalGames) modalGames.textContent = progress.gamesPlayed.toString();
      
      // Update badges grid
      const badgesGrid = document.getElementById('badges-grid');
      if (badgesGrid) {
        badgesGrid.innerHTML = BADGES.map(b => {
          const earned = progress.badges.includes(b.id);
          return `
            <div class="badge-card ${earned ? 'earned' : 'locked'}">
              <span class="badge-icon">${b.icon}</span>
              <span class="badge-name">${b.name}</span>
            </div>
          `;
        }).join('');
      }
    };

    // Show XP notification
    const showXpNotification = (xp) => {
      const notif = document.getElementById('xp-notification');
      const gainEl = notif?.querySelector('.xp-gain');
      if (notif && gainEl && xp > 0) {
        gainEl.textContent = `+${xp} XP`;
        notif.hidden = false;
        notif.classList.add('show');
        setTimeout(() => {
          notif.classList.remove('show');
          setTimeout(() => { notif.hidden = true; }, 300);
        }, 2000);
      }
    };

    // Initialize and update streak on page load
    let progress = initGamification();
    
    // Update streak for daily visit
    const today = new Date().toISOString().split('T')[0];
    if (progress.lastVisit !== today) {
      let xpGained = 0;
      
      if (!progress.lastVisit) {
        progress.streak = 1;
        progress.totalVisits = 1;
        xpGained = 110; // First visit + daily
        if (!progress.badges.includes('first_steps')) {
          progress.badges.push('first_steps');
        }
      } else {
        const lastDate = new Date(progress.lastVisit);
        const todayDate = new Date(today);
        const diffDays = Math.floor((todayDate.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          progress.streak += 1;
          xpGained = 10 + (progress.streak * 5);
        } else {
          progress.streak = 1;
          xpGained = 10;
        }
        progress.totalVisits += 1;
      }
      
      progress.lastVisit = today;
      progress.xp += xpGained;
      
      // Recalculate level
      for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (progress.xp >= LEVELS[i].xp) {
          progress.level = LEVELS[i].level;
          break;
        }
      }
      
      // Check streak badges
      if (progress.streak >= 3 && !progress.badges.includes('streak_starter')) {
        progress.badges.push('streak_starter');
      }
      if (progress.streak >= 7 && !progress.badges.includes('week_warrior')) {
        progress.badges.push('week_warrior');
      }
      
      localStorage.setItem('bitlingo-progress', JSON.stringify(progress));
      
      // Show XP notification after a short delay
      setTimeout(() => showXpNotification(xpGained), 500);
    }
    
    updateDisplay(progress);
    
    // Modal handling
    const modal = document.getElementById('badges-modal');
    const expandBtn = document.getElementById('badges-expand');
    const closeBtn = document.getElementById('modal-close');
    const backdrop = modal?.querySelector('.modal-backdrop');
    
    const openModal = () => {
      if (modal) {
        // Calculate header height dynamically and adjust modal/backdrop to not cover header
        const header = document.querySelector('header');
        const backdrop = modal.querySelector('.modal-backdrop');
        if (header) {
          const headerHeight = header.offsetHeight;
          // Adjust modal container to start below header
          modal.style.top = `${headerHeight}px`;
          modal.style.height = `calc(100% - ${headerHeight}px)`;
          // Adjust backdrop to fill remaining space
          if (backdrop) {
            backdrop.style.top = '0';
            backdrop.style.height = '100%';
          }
        }
        modal.hidden = false;
        setTimeout(() => modal.classList.add('open'), 10);
      }
    };
    
    const closeModal = () => {
      if (modal) {
        modal.classList.remove('open');
        setTimeout(() => { 
          modal.hidden = true;
          // Reset modal position when closed
          modal.style.top = '';
          modal.style.height = '';
        }, 300);
      }
    };
    
    // Widget is now a link - let it navigate naturally
    // Only prevent navigation if clicking on badges-expand button (it opens modal)
    const handleWidgetClick = (e) => {
      const clickedExpandBtn = e.target.closest('.badges-expand');
      if (clickedExpandBtn) {
        e.preventDefault();
        e.stopPropagation();
        openModal();
      }
      // Otherwise, let the link navigate to the progress page
    };
    
    widget.addEventListener('click', handleWidgetClick);
    
    expandBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openModal();
    });
    closeBtn?.addEventListener('click', closeModal);
    backdrop?.addEventListener('click', closeModal);
    
    // Listen for custom events from games
    window.addEventListener('bitlingo:quiz-complete', () => {
      progress.quizzesCompleted += 1;
      progress.xp += 50;
      for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (progress.xp >= LEVELS[i].xp) { progress.level = LEVELS[i].level; break; }
      }
      if (progress.quizzesCompleted >= 10 && !progress.badges.includes('quiz_master')) {
        progress.badges.push('quiz_master');
      }
      localStorage.setItem('bitlingo-progress', JSON.stringify(progress));
      updateDisplay(progress);
      showXpNotification(50);
    });
    
    window.addEventListener('bitlingo:game-complete', () => {
      progress.gamesPlayed += 1;
      progress.xp += 30;
      for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (progress.xp >= LEVELS[i].xp) { progress.level = LEVELS[i].level; break; }
      }
      if (progress.gamesPlayed >= 20 && !progress.badges.includes('game_lover')) {
        progress.badges.push('game_lover');
      }
      localStorage.setItem('bitlingo-progress', JSON.stringify(progress));
      updateDisplay(progress);
      showXpNotification(30);
    });
  });
</script>

<style>
  .progress-widget {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    font-size: 0.85rem;
    position: relative;
    cursor: pointer !important;
    transition: all 0.2s ease;
    pointer-events: auto !important;
    z-index: 10003 !important;
    user-select: none;
    text-decoration: none;
    color: inherit;
  }

  .progress-widget:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(245, 166, 35, 0.3);
    text-decoration: none;
    color: inherit;
  }

  .progress-widget,
  .progress-widget *,
  .progress-widget .progress-content,
  .progress-widget .stat,
  .progress-widget .stat-icon,
  .progress-widget .stat-info,
  .progress-widget .stat-value,
  .progress-widget .stat-label {
    cursor: pointer !important;
    pointer-events: auto !important;
  }

  .progress-widget .badges-expand {
    pointer-events: auto !important;
  }

  .progress-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer !important;
    pointer-events: auto !important;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer !important;
    pointer-events: auto !important;
  }

  .stat-icon {
    font-size: 1.1rem;
  }

  .stat-info {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    gap: 0.25rem;
    line-height: 1.2;
    white-space: nowrap;
  }

  .stat-value {
    font-weight: 700;
    color: var(--text-primary);
  }

  .stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .xp-bar-container {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 80px;
  }

  .xp-info {
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .xp-next {
    opacity: 0.6;
  }

  .xp-bar {
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
  }

  .xp-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-light));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  .badges-preview {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .badges-list {
    display: flex;
    gap: 0.15rem;
  }

  .badge-icon {
    font-size: 1rem;
  }

  .badges-expand {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: color 0.2s;
    pointer-events: auto !important;
    position: relative;
    z-index: 10;
  }

  .badges-expand:hover {
    color: var(--accent-primary);
  }

  .badges-expand svg {
    width: 16px;
    height: 16px;
  }

  /* XP Notification */
  .xp-notification {
    position: absolute;
    top: -30px;
    right: 10px;
    background: var(--accent-primary);
    color: var(--bg-primary);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.8rem;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: none;
  }

  .xp-notification.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Modal */
  .badges-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: auto;
    /* Top position will be set dynamically via JavaScript to exclude header */
  }

  .badges-modal.open .modal-backdrop {
    opacity: 1;
  }

  .modal-content {
    position: relative;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    opacity: 0;
    transition: all 0.3s ease;
  }

  .badges-modal.open .modal-content {
    transform: scale(1);
    opacity: 1;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
  }

  .modal-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-subtle);
    border-radius: 50%;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
  }

  .modal-close svg {
    width: 18px;
    height: 18px;
  }

  .modal-stats {
    display: flex;
    justify-content: space-around;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
    margin-bottom: 1.5rem;
  }

  .modal-stat {
    text-align: center;
  }

  .modal-stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-primary);
  }

  .modal-stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
  }

  .badge-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all 0.2s;
  }

  .badge-card.earned {
    background: rgba(245, 166, 35, 0.1);
    border-color: var(--border-accent);
  }

  .badge-card.locked {
    opacity: 0.4;
    filter: grayscale(100%);
  }

  .badge-card .badge-icon {
    font-size: 2rem;
  }

  .badge-name {
    font-size: 0.7rem;
    color: var(--text-secondary);
    text-align: center;
  }

  /* Progress Guide Section */
  .progress-guide {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-subtle);
  }

  .progress-guide h4 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .guide-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .guide-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
    transition: all 0.2s;
  }

  .guide-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .guide-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .guide-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
  }

  .guide-content strong {
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .guide-xp {
    font-size: 0.75rem;
    color: var(--accent-primary);
    font-weight: 600;
  }

  /* Compact mode */
  .progress-widget.compact .xp-bar-container,
  .progress-widget.compact .badges-preview {
    display: none;
  }

  @media (max-width: 768px) {
    .progress-widget {
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
      gap: 0.5rem;
    }
    
    .progress-content {
      gap: 0.5rem;
    }
    
    .stat {
      gap: 0.25rem;
    }
    
    .stat-icon {
      font-size: 0.9rem;
    }
    
    .stat-value {
      font-size: 0.85rem;
    }
    
    .stat-label {
      font-size: 0.65rem;
    }
    
    .stat-info {
      gap: 0.15rem;
    }
    
    .xp-bar-container {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .progress-widget {
      padding: 0.25rem 0.4rem;
      font-size: 0.7rem;
      gap: 0.4rem;
    }
    
    .progress-content {
      gap: 0.4rem;
    }
    
    .stat {
      gap: 0.2rem;
    }
    
    .stat-icon {
      font-size: 0.8rem;
    }
    
    .stat-value {
      font-size: 0.75rem;
    }
    
    .stat-label {
      font-size: 0.6rem;
    }
    
    .stat-info {
      gap: 0.1rem;
    }
  }
</style>
