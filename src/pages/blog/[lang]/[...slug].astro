---
import { getCollection, render } from 'astro:content';
import BlogPost from '../../../layouts/BlogPost.astro';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '../../../consts';
import { calculateReadingTime } from '../../../utils/readingTime';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const getPathSlug = (post: (typeof posts)[number]) => {
		if (post.data.path) return post.data.path;
		if (post.data.slug?.startsWith(`${post.data.lang}-`)) {
			return post.data.slug.slice(post.data.lang.length + 1);
		}
		return post.data.slug ?? post.slug ?? post.id;
	};
	return SUPPORTED_LANGS.flatMap((lang) =>
		posts
			.filter((post) => post.data.lang === lang)
			.map((post) => ({
				params: { lang, slug: getPathSlug(post) },
				props: { postId: post.id },
			})),
	);
}

const { lang, slug } = Astro.params;
if (!SUPPORTED_LANGS.includes(lang)) {
	return Astro.redirect(`/blog/${DEFAULT_LANG}/${slug}/`, 308);
}

const posts = await getCollection('blog');
const getPathSlug = (post: (typeof posts)[number]) => {
	if (post.data.path) return post.data.path;
	if (post.data.slug?.startsWith(`${post.data.lang}-`)) {
		return post.data.slug.slice(post.data.lang.length + 1);
	}
	return post.data.slug ?? post.slug ?? post.id;
};
let post = posts.find(
	(p) => p.data.lang === lang && getPathSlug(p) === slug,
);

if (!post) {
	post = posts.find(
		(p) => p.data.lang === DEFAULT_LANG && getPathSlug(p) === slug,
	);
}

if (!post) {
	return new Response(null, { status: 404 });
}

const { Content } = await render(post);
const readingTime = calculateReadingTime(post.body || '');
---

<BlogPost {...post.data} readingTime={readingTime}>
	<Content />
</BlogPost>
